# Execution Tools and Interfaces

`Run elPaSo as you wish! Parametric? No problem! Call elPaSo and process the results as you wish!`

You can parametrize your model, solve with elPaSo for any input and collect results. Currently we offer interface 
for your codes in MATLAB or python.

The main goal of the interfaces are to provide the following functionalities:
1. change the elPaSo `hdf5` problem file w.r.t. desired material parameters,
2. run elPaSo (with python toolbox - deploy problems also on HPC clusters ðŸ’¡), and
3. import data generated by the elPaSo solver (for instance solutions, system matrices, etc.) into MATLAB/python.

## elPaSo-MATLAB interface

### Initial setup

A one time setup is required to call elPaSo from your MATLAB codes. Follow the steps below to prepare your MATLAB environment:
1. Check for basic requirements:
    - elPaSo installation and access to `elpasoC` executable. See [Installation Guide](./installation/install_executable.md).
    - MATLAB (stable R2018b and above)
    - [HDFView](https://www.hdfgroup.org/downloads/hdfview/) for viewing elPaSo hdf5 files.
2. Download the elPaSo toolbox for MATLAB to your code directory
    - Download the elPaSo source code from the gitlab page or download directly as [zip](https://git.rz.tu-bs.de/akustik/elPaSo-Core/-/archive/master/elPaSo-Core-master.zip), [tar.gz](https://git.rz.tu-bs.de/akustik/elPaSo-Core/-/archive/master/elPaSo-Core-master.tar.gz).
    - Copy the folder '<elPaSo_Code_Repository>/tools/MATLAB/elpaso-toolbox' to your MATLAB workspace. This folder contains the necessary tools and examples.
3. Now you are ready to incorporate elPaSo in your codes! Start with [defining the problem](matlab-define-problem).

(matlab-define-problem)=
### Define the problem specific system

elPaSo is capable for solving various problem types. Therefore, you need a MATLAB function to control the various problem types - and we call them a **system**. We include some usage examples in `elpaso-toolbox/examples/`. Following is are the explanation for setting up an FSI system `elpaso-toolbox/systems/setup_system_fsi.m`:
1. Define elPaSo controls with the struct object **elpasoControls**. Make sure you are pointing towards the correct executable.
    ```{warning}
    elpasoControls.environment should be set to `export LD_LIBRARY_PATH=none && source /software/intel2020/compilers_and_libraries/linux/bin/compilervars.sh -arch intel64 -platform linux` for intel compilers. Or else, elpaso results are incorrect due to conflict with MATLAB dynamic libraries.
    ```
2. Define elPaSo problem with `elpasoProblemHdf5` variable containing the absolute path to the elpaso hdf5 file.
3. Define materials with `materials` array with structure according to elpaso hdf5 file (open the file with HDFView and refer to path `Materials`). This is how you introduce the parameter values $p$ passed to the function.
4. You are ready to use this system. See `elpaso-toolbox/examples/main_functionalities_fsi_system.m` for usage.

### Import dynamic system matrix to MATLAB

This function is meant to be used in the **system** function.

```matlab
[KDYN] = elpasoComputeAndExportDynamicSystemMatrix(elpasoControlStruct, elpasoProblemHdf5, materials, compute_for_freq);
```

Input parameters:
- `elpasoControlStruct`: elpaso controls to run the elpasoC executable
- `elpasoProblemHdf5`: elpaso hdf5 filename WITH extension
- `materials`: material struct
- `compute_for_freq`: frequency step to compute

Output parameters:
- `KDYN`: Dynamic stiffness matrix

OR if you already have access to the `eGenSystem_<problem_name>.hdf5` file, you can skip the elpaso computation and directly use the reader function:
```matlab
exportedSystemFile = 'eGenSystem_<problem_name>.hdf5';
KDYN = H5CSRToSparseMatFOM(exportedSystemFile, '/DynamicStiffness');
```

### Import stiffness and mass matrices to MATLAB

```{warning}
This feature is available only with elPaSo Research module.
```

If you have the elPaSo hdf5 file ready, use the function `elpasoComputeAndExportSystemMatrices` to generate the `eGenSystem_<problem_name>.hdf5` containing the system matrices. You get access to the stiffness and mass matrix:
```matlab
[KMAT, MMAT] = elpasoComputeAndExportSystemMatrices(elpasoControlStruct, elpasoProblemHdf5, materials);
```
Input parameters:
- `elpasoControlStruct`: A struct object containing the necessary elPaSo controls
- `elpasoProblemHdf5`: The elPaSo input file including absolute path, for example <tt>'/home/user/example_problem/example_problem.hdf5'</tt>.
- `materials`: material struct

Return parameters:
- `KMAT`: Stiffness matrix of dimension $n \times n$, where $n$ is the total degrees of freedom.
- `MMAT`: Mass matrix of dimension $n \times n$

OR if you already have access to the `eGenSystem_<problem_name>.hdf5` file, you can skip the elpaso computation and directly use the reader function:
```matlab
exportedSystemFile = 'eGenSystem_<problem_name>.hdf5';
KMAT = H5CSRToSparseMatFOM(exportedSystemFile, '/Stiffness');
MMAT = H5CSRToSparseMatFOM(exportedSystemFile, '/Mass');
```

### Import solution to MATLAB

Similar to the system matrices import routine, you can perform solving with elPaSo and import the solution directly:
```matlab
[solution, node2dofMap, freq] = elpasoComputeAndExportSystemSolution(elpasoControlStruct, elpasoProblemHdf5, materials, compute_for_freq)
```
Input parameters:
- `elpasoControlStruct`: A struct object containing the necessary elPaSo controls
- `elpasoProblemHdf5`: The elPaSo input file including absolute path, for example <tt>'/home/user/example_problem/example_problem.hdf5'</tt>.
- `materials`: material struct
- `compute_for_freq`: frequency step to compute

Return parameters:
- `solution`: Complex matrix with dimension $n \times n_\mathrm{freq}$, where $n$ is the total degrees of freedom and $n_\mathrm{freq}$ is the number of frequency steps.
- `node2dofMap`: An $n \times 2$ matrix with first column representing the node ID and second column representing the type of degree of freedom. The respective row number can be related to the solution. For example, $i^\mathrm{th}$ row entry '1,3' in `node2dofMap` denote deflection of node 1 in $z$-direction and the corresponding solution is in the $i^\mathrm{th}$ row of `solution`.
- `freq`: Array of size $n_\mathrm{freq}$ containing the frequency steps in Hz for which the system is solved. 

OR if you already have access to the `eGenOutput_<problem_name>.hdf5` file, you can skip the elpaso computation and directly use the reader function:
```matlab
[solution, node2dofMap, freq] = elpasoReadSolutionFile('eGenOutput_<problem_name>.hdf5');
```

### Overview of all functionalities

| **Function**                  | **Description** |
|---------------------------|--------|
|**functions calling elPaSo**||
| elpasoComputeAndExportDynamicSystemMatrix                     | Calls elPaSo to extract dynamic system matrix and return the imported matrix |
| elpasoComputeAndExportSystemMatrices                         | Calls elPaSo to extract system matrices and return the imported matrices       |
| elpasoComputeAndExportSystemSolution                          | Calls elPaSo to compute solution and return the imported solution |
|**functions to change elpaso hdf5**||
|elpasoChangeMaterialInElpasoHdf5 | Changes the material parameters in elpaso hdf5 |
|**functions parsing elPaSo data**||
|H5CSRToSparseMatFOM | Reads the sparse matrix written in CSR style from 'eGenSystem_*.hdf5' file |
|elpasoReadSolution | Reads the elpaso solution from 'eGenOutput_*.hdf5' file |
|H5VecRead | Reads a complex vector (as compound dataset) from hdf5  |
|**auxiliary functions to process fsi problems**|
|elpasoPostProcessSystemMatricesForFSI | Corrects the stiffness and mass matrices with the correct coupling entries |
|elpasoRemoveStructInplaneDofsForFSI | Removes the in-place DOFs from the structural domain |

### Interface tets

A verification script is provided in `elpaso-toolbox/examples/main_test_fsi_system.m`. The FRF graphs must match.

## elPaSo-Python interface

```{note}
Under construction. Content will be available soon.
```